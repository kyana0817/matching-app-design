# ユーザー認証

SNSやECサイト、サブスクライブなどユーザーに紐づいた何らかの動作があるサービスには、ほとんどの場合ユーザーアカウントを使った認証が必要になります。

ユーザー認証はサインアップやログイン以外も、SNSの投稿機能など、どのユーザーが行なった動作なのかを保証するためのものでもあります。

つまりそういったサービスを作る際には、ほぼ必須でユーザー認証機能が必要になるのですが、実装難易度やセキュリティー面など考慮する必要があり、特に慎重な実装を行う必要があります

## 実装パターン

ユーザー認証には、ステートフルとステートレスの２種類の実装があります。

- ステートフルによる実装

  ```mermaid
  sequenceDiagram
      actor client as ユーザー
      participant web as アプリケーションサーバー
      client->>web: ログインリクエスト
      web->>web: セッションIDを生成
      web->>web: セッションIDとユーザーを紐づけ、なんらかのストレージに保存
      web->>client: セッションID付きのレスポンス
      Note left of web: CookieにセッションIDが含まれる
      client->>web: リクエスト
      web->>web: セッションIDに紐づくユーザーを取得
      web->>client: ユーザーごとのレスポンス
      
  ```

  ログイン時にユーザーごとの固有なセッションIDをアプリケーションサーバーで生成します。

  セッションIDを生成後、セッションが有効である限りユーザーへのレスポンスには必ずセッションIDを含め、送信することになります。

  ログイン後のページ遷移などアプリケーションサーバーにリクエストを送る際には、毎回のリクエストにセッションIDを含めて送信を行う必要があります。アプリケーションサーバーはユーザーの送信に含まれるセッションIDを元に表示される内容をユーザーごとに切り替えます。

  ログアウトの時にはアプリケーションサーバー側でセッションIDを削除することで、ユーザーが再度通信を行うときに既に所持しているセッションIDを使って認証を受けることが出来なくなるので、ログインページにリダイレクトを行い再度セッションIDを取得するようになります。

  セッションIDは情報を持たせず、ユーザーとの関連があるだけです。

  

- ステートレスによる実装

  ```mermaid
  sequenceDiagram
      actor client as ユーザー
      participant web as アプリケーションサーバー
      participant auth as 認証サーバー
      client->>web: リクエスト
      web->>client: レスポンス
      Note left of web: ユーザー認証を行うプログラムが含まれる
      alt トークンを所持していない場合
  	    client->>auth: ユーザー認証
      	auth->>client: トークンを取得
  	    client->>client: トークンを localstorage に格納
      end
      alt 認証が必要な通信
          client->>web: トークン付きのリクエスト
          web->>auth: トークンの認証
          auth->>web: 認証結果
          web->>web: トークンの情報からユーザーの情報を取得
          web->>client: ユーザーごとのレスポンス
      end
      
  ```
  
  ユーザーはアプリケーションサーバーにリクエストを送信し、レスポンスに含まれるクライアントサイドで実行されるプログラムによって認証情報のチェックを行います。
  
  クライアント側にトークンがない状態(未ログイン)の場合、ログインページの認証情報をアプリケーションサーバーを介さず認証サーバーに送信し、ユーザーのトークンを localstorage に格納します。
  
  認証が必要な通信にはトークンをヘッダーに含み、アプリケーションサーバーにリクエストを送信します。
  
  アプリケーションサーバー側でトークンの認証を行い、認証が取ればトークンからユーザーを取得し、クライアント側にレスポンス返します。
  
  ステートレスの認証の場合は、トークンはクライアントだけがしている状態になります。
  
  トークンにはユーザーと紐づく情報が必要になります。
  
  

## どっちで実装するか

ステートフルの認証、ステートレスの認証どちらを選んでも、お互いにメリットもデメリットもあります。

フルスタックフレームワークである、Django、Rails、Laravel などで開発するフロントとバックが一つのフレームの中で開発される場合はステートフル認証を使用する場合が多く、フロントをReactやVueなどで開発し、バックをAPIとして開発する場合はステートレス認証が多い気がします。

どちらの認証方式を選んでもメリットとデメリットを考慮し、その時の最適だと思う実装でよいと思っています。



## Firebaseを使った実装

[Firebase](https://console.firebase.google.com/)

上記のURLに移動して、プロジェクトを作成します。

<img src="./assets/auth-1.png" alt="auth-1" style="zoom:50%;" />

上記の画像は既にプロジェクトがある状態なので初期状態と少し違います。

このページ内のプロジェクトを追加というボタンがあるのでそれを選択します。

### プロジェクトを作成

<img src="./assets/auth-2.png" alt="auth-2" style="zoom:50%;" />

<img src="./assets/auth-3.png" alt="auth-3" style="zoom:50%;" />

<img src="./assets/auth-4.png" alt="auth-4" style="zoom:50%;" />

プロジェクトを作成 というボタンを押すと、ローディング画面になります。

<img src="./assets/auth-5.png" alt="auth-5" style="zoom:50%;" />

プロジェクトの作成が完了すると、続行というボタンが表示されるのでそれを選択します。



### 認証プロパイダーを設定

<img src="./assets/auth-6.png" alt="auth-6" style="zoom:50%;" />

プロジェクトのダッシュボードを表示されたら、左側サイドメニューにある、**構築**をクリックしドロワーを開きます。

ドロワーの中に **Authentication** の項目があるのでそれを選択します。

<img src="./assets/auth-7.png" alt="auth-7" style="zoom:50%;" />

<img src="./assets/auth-8.png" alt="auth-8" style="zoom:50%;" />

この例では、シンプルな認証方法で実装を進めるので、**ネイティブのプロパイダ** の中にある **メール/パスワード** を選択します。

<img src="./assets/auth-9.png" alt="auth-9" style="zoom:50%;" />

**メール/パスワード** の項目だけ有効にして**保存**を選択します

<img src="./assets/auth-10.png" alt="auth-10" style="zoom:50%;" />

保存が完了したら、ユーザーの一覧が表示されます。

プロパイダの作成が完了したら、サイドメニューの**プロジェクトの概要**を選択します。

### SDK用のキーを取得

Firebaseなど、既存のサービスをプロジェクトに組み込み際には、公式が配布しているSDK使用します。

SDKは、Software Development Kit の略で既存のサービスをプログラムから操作するためのツールを提供しているものになります。

FirebaseのSDKを使用するためには、アプリ固有キーが必要になるのでそれを取得していきます。

<img src="./assets/auth-11.png" alt="auth-11" style="zoom:50%;" />

<img src="./assets/auth-12.png" alt="auth-12" style="zoom:50%;" />

<img src="./assets/auth-13.png" alt="auth-13" style="zoom:50%;" />

アプリの登録が完了すると、SDKを使用するためのシークレットな情報が表示されるのでメモしてください。



## クライアントサイドの構築

[firebaseでユーザー認証機能実装したやつ](https://github.com/kyana0818/firebase-auth-example)



